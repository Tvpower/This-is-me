trigger:
  - main # Runs whenever code is pushed to main
pool:
  name: 'Default'

parameters:
  - name: buildConfiguration
    displayName: Build Config
    type: string
    default: release
    values:
      - release
      - debug

variables:
  DB_URL: 'mysql://$(DB_USER):$(DB_PASSWORD)@host.docker.internal:3306/$(DB_NAME)'
  frontendImageName: 'frontend-app'
  backendImageName: 'backend-app'

stages:
  - stage: Build
    displayName: Build and Push Stage
    jobs:
        # JOB 1: BACKEND
      - job: BuildBackend
        displayName: Build Backend Image
        steps:
          # FIXED: Added the missing 'task' block
          - task: Docker@2
            displayName: Build Backend
            inputs:
              command: build
              repository: $(backendImageName)
              dockerfile: 'backend/Dockerfile'
              tags: |
                latest
                $(Build.BuildId)
              arguments: '--build-arg DATABASE_URL=$(DB_URL)'

      - job: BuildFrontEnd
        displayName: Build Next.js FE
        steps:
          - task: Docker@2
            displayName: Build FE image
            inputs:
              command: build
              repository: $(frontendImageName)
              dockerfile: 'frontend/Dockerfile'
              tags: |
                latest
                $(Build.BuildId)
        
